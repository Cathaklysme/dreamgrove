actions.precombat=moonkin_form
actions.precombat+=/variable,name=dadspec,value=0

actions=moonfire,target_if=refreshable,if=(cooldown.ca_inc.ready|eclipse.state=2&spell_targets.starfire<5|(talent.twin_moons.enabled&spell_targets.starfire<10))&!buff.runecarve_3_nature.up&!buff.runecarve_3_arcane.up
actions+=/sunfire,target_if=refreshable,if=!buff.runecarve_3_nature.up&!buff.runecarve_3_arcane.up&(buff.ca_inc.remains>10|!buff.ca_inc.up)
actions+=/stellar_flare,target_if=refreshable&spell_targets.starfire<3&ap_check,if=!buff.runecarve_3_nature.up&!buff.runecarve_3_arcane.up&buff.ca_inc.remains>10
actions+=/starsurge,if=cooldown.ca_inc.up&cooldown.convoke_the_spirits.up&astral_power>40&legendary.crit
actions+=/celestial_alignment,if=floor((fight_remains-10)%cooldown)>floor((fight_remains-10-cooldown.convoke_the_spirits.remains)%cooldown)&!legendary.crit|cooldown.convoke_the_spirits.up|!covenant.night_fae&!buff.ca_inc.up&ap_check
actions+=/variable,name=convoke_condition,value=floor((fight_remains-10)%120)>floor((fight_remains-10-cooldown.ca_inc.remains)%120)
actions+=/convoke_the_spirits,if=variable.convoke_condition&(spell_targets.starfire<3|buff.eclipse_lunar.up&spell_targets.starfire>2)&((astral_power<30&eclipse.state=3&buff.primordial_arcanic_pulsar.value<340)|buff.runecarve_3_nature.up|buff.runecarve_3_arcane.up)
actions+=/fury_of_elune,if=eclipse.state=3&ap_check&buff.primordial_arcanic_pulsar.value<340&!(cooldown.convoke_the_spirits.ready&buff.ca_inc.up)
actions+=/force_of_nature
actions+=/kindred_spirits
actions+=/ravenous_frenzy
actions+=/adaptive_swarm
actions+=/starsurge,if=(spell_targets.starfall=1|!variable.dadspec)&buff.primordial_arcanic_pulsar.value<370&(buff.eclipse_solar.up&spell_targets.starfire=1|buff.eclipse_lunar.up&spell_targets.starfire>1)|buff.oneths_clear_vision.up|astral_power>90&(spell_targets.starfall=1|!variable.dadspec|buff.starfall.up)|(covenant.night_fae&variable.convoke_condition&(astral_power>80|spell_targets.starfall=1)&cooldown.convoke_the_spirits.up)
actions+=/starfall,if=!buff.starfall.up&(spell_targets>1|variable.dadspec|buff.oneths_perception.up)
actions+=/new_moon,if=buff.eclipse_lunar.up|(charges=2&recharge_time<5)|charges=3&ap_check
actions+=/half_moon,if=buff.eclipse_lunar.up|(charges=2&recharge_time<5)|charges=3&ap_check
actions+=/full_moon,if=buff.eclipse_lunar.up|(charges=2&recharge_time<5)|charges=3&ap_check
actions+=/wrath,if=buff.eclipse_solar.up&(!buff.eclipse_lunar.up|spell_targets.starfire=1)&spell_targets<=3&(buff.ca_inc.remains>execute_time|!buff.ca_inc.up)
actions+=/warrior_of_elune
actions+=/starfire,if=buff.eclipse_lunar.up|eclipse.state=1|eclipse.state=0&spell_targets=1|buff.eclipse_solar.up&spell_targets>3|buff.ca_inc.remains>action.wrath.execute_time&spell_targets=1
actions+=/wrath
